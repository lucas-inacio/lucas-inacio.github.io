<!DOCTYPE html>
<html class="background">
<!-- <html style="background-color: #222;"> -->
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Blog do Lucas</title>
        
<link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">

        
<link rel="stylesheet" href="/prism/prism.css">

        
<script src="/bootstrap/js/bootstrap.bundle.min.js"></script>

        <style>
            .backgroundC {
                background-color: #0A0A0A;
            }

            .mainC {
                background-color: #222;
            }

            .headC {
                background-color: #333;
            }

            .titleC {
                background-color: seagreen;
            }

            img {
                max-width: 43vw;
                margin-top: 4px;
                margin-bottom: 4px;
            }

            @media(max-width: 800px) {
                img {
                    max-width: 90%;
                }
            }
        </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>
    <body class="backgroundC">
    <!-- <body style="background-color: #222;"> -->
        <div class="main">
            <div class="container-fluid sticky-top bg-dark">
                <h1 class="container title bg-dark text-white hideOnScroll">
                    Blog do Lucas
                </h1>
                <p class="container text-white hideOnScroll">Salvando aqui minhas ideias para não inventar tudo de novo.</p>
                <div class="container">
    <!-- Somente em telas md e acima -->
    <ul class="nav d-none d-lg-flex justify-content-center">
        
            <li class="nav-item">
                <a class="nav-link text-white" href="/">Início</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-link text-white" href="/archives">Arquivo</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-link text-white" target="_blank" rel="noopener" href="https://github.com/lucas-inacio">GitHub</a>
            </li>
        
    </ul>

    <!-- Somente em telas pequenas -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark d-block d-lg-none">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#navBarContent" arai-controls="navBarContent" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end bg-dark" id="navBarContent">
                <div class="offcanvas-header text-white">
                    <h3>Menu</h3>
                    <button type="button" class="btn-close bg-white text-reset float-start" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="list-group">
                        
                            <a class="list-group-item titleC text-dark" href="/">Início</a>
                        
                            <a class="list-group-item titleC text-dark" href="/archives">Arquivo</a>
                        
                            <a class="list-group-item titleC text-dark" target="_blank" rel="noopener" href="https://github.com/lucas-inacio">GitHub</a>
                        
                        <hr />
                        
                            <a class="list-group-item titleC text-dark" href="/categories/C/">C++</a>
                        
                            <a class="list-group-item titleC text-dark" href="/categories/Matematica/">Matemática</a>
                        
                            <a class="list-group-item titleC text-dark" href="/categories/Microcontroladores/">Microcontroladores</a>
                        
                            <a class="list-group-item titleC text-dark" href="/categories/Geral/">Geral</a>
                        
                            <a class="list-group-item titleC text-dark" href="/categories/Matematica/Medicina/">Medicina</a>
                        
                    </ul>
                </div>
            </div>
        </div>
    </nav>
</div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 text-secondary">
                        <div class="row text-white pt-3" style="color: white;">
    <h1>Dicas para usar libserialport</h1>
    <div class="text-white">
        05/02/2022 
    </div>
    <p>Dicas valiosas para quem quer utilizar essa biblioteca para comunicação serial.</p>
<span id="more"></span>
<h2 id="O-que-e-a-libserialport"><a href="#O-que-e-a-libserialport" class="headerlink" title="O que é a libserialport"></a>O que é a libserialport</h2><p>É uma biblioteca multiplataforma escrita em C destinada a facilitar o desenvolvimento de programas que utilizam comunicação serial. Ela é desenvolvida e mantida pela <a target="_blank" rel="noopener" href="https://sigrok.org/">Sigrok</a>.</p>
<h2 id="Problemas-encontrados"><a href="#Problemas-encontrados" class="headerlink" title="Problemas encontrados"></a>Problemas encontrados</h2><p>Ao utilizar a biblioteca eu enfrentei dois desafios. Um deles foi a ausência de dados recebidos ao tentar se conectar a uma Raspberry Pi Pico. O outro estava relacionado com a detecção de desconexão. Abaixo é relatada a forma como eu os resolvi.</p>
<h4 id="Ausencia-de-dados"><a href="#Ausencia-de-dados" class="headerlink" title="Ausência de dados"></a>Ausência de dados</h4><p>Após realizar a abertura da porta desejada e configurá-la não havia dados de entrada. A configuração utilizada segue logo abaixo:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Os erros não são checados neste exemplo apenas para diminuir o tamanho do código
sp_port *port;
sp_get_port_by_name(&quot;COM3&quot;, &amp;port);
sp_open(port, SP_MODE_READ_WRITE);

sp_port_config *config;
sp_new_config(&amp;config);
sp_set_config_baudrate(config, 9600);
sp_set_config_bits(config, 8);
sp_set_config_flowcontrol(config, SP_FLOWCONTROL_NONE);
sp_set_config_parity(config, SP_PARITY_NONE);
sp_set_config_stopbits(config, 1);
sp_set_config(port, config);
sp_free_config(config);

char buffer;
&#x2F;&#x2F; Nunca recebe nada a não ser que a porta já tenha sido aberta por outro programa
&#x2F;&#x2F; que a configura corretamente.
sp_blocking_read(port, &amp;buffer, 1, 0);
sp_close(port);
sp_free_port(port);</code></pre>

<p>Graças a <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/8910167">essa resposta</a> foi possível resolver o problema.<br>O código completo segue abaixo com a inclusão da configuração necessária:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Os erros não são checados neste exemplo apenas para diminuir o tamanho do código
sp_port *port;
sp_get_port_by_name(&quot;COM3&quot;, &amp;port);
sp_open(port, SP_MODE_READ_WRITE);

sp_port_config *config;
sp_new_config(&amp;config);
sp_set_config_baudrate(config, 9600);
sp_set_config_bits(config, 8);
sp_set_config_flowcontrol(config, SP_FLOWCONTROL_NONE);
sp_set_config_parity(config, SP_PARITY_NONE);
sp_set_config_stopbits(config, 1);

&#x2F;&#x2F; As duas linhas abaixo são a chave.
sp_set_config_dtr(config, SP_DTR_ON);
sp_set_config_rts(config, SP_RTS_ON);

sp_set_config(port, config);
sp_free_config(config);

char buffer;
&#x2F;&#x2F; Agora funciona.
sp_blocking_read(port, &amp;buffer, 1, 0);
sp_close(port);
sp_free_port(port);</code></pre>
<p>Este problema nunca acontecia com um Arduino Nano, por exemplo. Aparentemente apenas alguns dispositivos se comportam dessa maneira.</p>
<h4 id="Detectar-desconexao"><a href="#Detectar-desconexao" class="headerlink" title="Detectar desconexão"></a>Detectar desconexão</h4><p>A maioria das funções da biblioteca libserialport retorna um valor do tipo enum sp_return. A constante SP_OK significa sucesso na operação. Outros valores podem signifcar erros (valores negativos) ou ainda ter outros siginificados dependendo da função chamada.<br>No entanto sp_blocking_read e sp_nonblocking_read não retornam nenhum erro se a porta for desconectada após aberta. Utilizei um hack para detectar o evento:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">bool SerialPort::checkConnected() const &#123;
    sp_signal signals;
    &#x2F;&#x2F; sp_get_signals falhará se a porta for desconectada
    if (sp_get_signals(mPort, &amp;signals) &#x3D;&#x3D; SP_OK) &#123;
        return true;
    &#125;
    return false;
&#125;</code></pre>
<p>A função sp_get_signals falha ao desconectar a porta. Com isso é possível checar periodicamente se a porta ainda está disponível.</p>
<h4 id="Problemas-resolvidos"><a href="#Problemas-resolvidos" class="headerlink" title="Problemas resolvidos"></a>Problemas resolvidos</h4><p>Os detalhes descritos podem ser úteis se estiver escrevendo uma aplicação que necessite se comunicar pela porta serial. A última solução é mais um “hack”, mas resolveu o problema. Espero que a informação auxilie no seu próximo projeto.</p>

</div>
                    </div>
                    <!-- Ativo apenas em telas md e acima. -->
<div class="text-center list-group col-lg-4 d-none d-lg-block px-3">
    <div class="sticky-top rounded-bottom" style="top: 152px;">
        <h5 class="text-white headC p-1 m-0 b-0 rounded-top">Categorias</h5> 
        
            <a class="list-group-item mainC text-white border-bottom border-0 border-success px-3" href="/categories/C/">C++</a>
        
            <a class="list-group-item mainC text-white border-bottom border-0 border-success px-3" href="/categories/Matematica/">Matemática</a>
        
            <a class="list-group-item mainC text-white border-bottom border-0 border-success px-3" href="/categories/Microcontroladores/">Microcontroladores</a>
        
            <a class="list-group-item mainC text-white border-bottom border-0 border-success px-3" href="/categories/Geral/">Geral</a>
        
            <a class="list-group-item mainC text-white border-bottom border-0 border-success px-3" href="/categories/Matematica/Medicina/">Medicina</a>
        
    </div>
</div>
                </div>
            </div>
        </div>
        
<script src="/prism/prism.js"></script>

        <script>
            function checkScroll(event) {
                let elements = document.getElementsByClassName('hideOnScroll');
                let offset = window.scrollY;

                if (offset > 130) {
                    for (let e of elements) {
                        e.classList.add('d-none');
                    }
                } else if (offset == 0) {
                    for (let e of elements) {
                        e.classList.remove('d-none');
                    }
                }
            }

            document.addEventListener('scroll', checkScroll);
        </script>
    </body>
</html>